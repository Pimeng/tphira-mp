# ÂΩì push Âà∞ main ‰∏îÊú¨Êèê‰∫§ÁöÑ package.json version ÊØî‰∏ä‰∏ÄÊèê‰∫§Êõ¥Êñ∞Êó∂ÔºåËá™Âä®ÔºöÊµãËØï ‚Üí ÊûÑÂª∫ ‚Üí ÂèëÂ∏É
name: ÁâàÊú¨Âè∑ÂèòÊõ¥Êó∂Ëá™Âä®ÂèëÂ∏É

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†ÅÔºàÂΩìÂâç + ‰∏ä‰∏ÄÊèê‰∫§Ôºâ
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Ê£ÄÊü•ÁâàÊú¨ÊòØÂê¶ÊØî‰∏ä‰∏ÄÊèê‰∫§Êõ¥Êñ∞
        id: check
        run: |
          current=$(node -p "require('./package.json').version")
          echo "version=$current" >> "$GITHUB_OUTPUT"

          # ‰∏ä‰∏ÄÊèê‰∫§ÁöÑ package.json ÁâàÊú¨ÔºàÊó†‰∏ä‰∏ÄÊèê‰∫§ÊàñËØªÂèñÂ§±Ë¥•ÂàôËßÜ‰∏∫ 0.0.0Ôºâ
          git show HEAD~1:package.json > /tmp/old-package.json 2>/dev/null || true
          if [[ -s /tmp/old-package.json ]]; then
            previous=$(node -p "try { require('/tmp/old-package.json').version } catch(e) { '0.0.0' }" 2>/dev/null) || previous="0.0.0"
          else
            previous="0.0.0"
          fi

          # ‰ªÖÂΩìÂΩìÂâçÁâàÊú¨ > ‰∏ä‰∏ÄÊèê‰∫§ÁâàÊú¨ Êó∂ÊâçÂèëÂ∏ÉÔºàx.y.z ËØ≠‰πâÂåñÊØîËæÉÔºâ
          node -e "
            const parse = v => { const m = (v || '0.0.0').match(/^(\\d+)\\.(\\d+)\\.(\\d+)/); return m ? [+m[1], +m[2], +m[3]] : [0,0,0]; };
            const a = parse(process.env.CURRENT), b = parse(process.env.PREVIOUS);
            let newer = false;
            for (let i = 0; i < 3; i++) {
              if (a[i] > b[i]) { newer = true; break; }
              if (a[i] < b[i]) break;
            }
            require('fs').appendFileSync(process.env.GITHUB_OUTPUT, 'should_release=' + newer + '\n');
          " CURRENT="$current" PREVIOUS="$previous"

          if [[ "$(grep should_release $GITHUB_OUTPUT | tail -1)" == "should_release=true" ]]; then
            echo "ÂΩìÂâçÊèê‰∫§ÁâàÊú¨: $current > ‰∏ä‰∏ÄÊèê‰∫§: $previousÔºåËß¶ÂèëÂèëÂ∏É"
          else
            echo "ÂΩìÂâç $current Êú™È´ò‰∫é‰∏ä‰∏ÄÊèê‰∫§ $previousÔºåË∑≥ËøáÂèëÂ∏É"
          fi

  test:
    needs: [check-version]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ËÆæÁΩÆ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"

      - name: ÂÆâË£Ö‰æùËµñ
        run: pnpm install --frozen-lockfile

      - name: ËøêË°åÊµãËØï
        run: pnpm test

  build:
    needs: [check-version, test]
    if: needs.check-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: ËÆæÁΩÆ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"

      - name: ÂÆâË£Ö‰æùËµñ
        run: pnpm install --frozen-lockfile

      - name: ÊûÑÂª∫ÂèØÊâßË°åÊñá‰ª∂
        run: pnpm run package:sea

      - name: Âà∂‰ΩúÂéãÁº©ÂåÖÔºàWinÔºâ
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $os = "${{ runner.os }}".ToLowerInvariant()
          $arch = "${{ runner.arch }}".ToLowerInvariant()
          $name = "phira-mp-$os-$arch.zip"
          if (Test-Path $name) { Remove-Item $name -Force }
          Compress-Archive -Path release\* -DestinationPath $name

      - name: Âà∂‰ΩúÂéãÁº©ÂåÖÔºàLinux/macOSÔºâ
        if: runner.os != 'Windows'
        shell: bash
        run: |
          os="$(printf "%s" "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')"
          arch="$(printf "%s" "${{ runner.arch }}" | tr '[:upper:]' '[:lower:]')"
          name="phira-mp-${os}-${arch}.zip"
          rm -f "$name"
          (cd release && zip -r "../$name" .)

      - name: ‰∏ä‰º†ÂéãÁº©ÂåÖ
        uses: actions/upload-artifact@v4
        with:
          name: phira-mp-${{ runner.os }}-${{ runner.arch }}
          path: |
            phira-mp-*.zip

  release:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ‰∏ãËΩΩÂéãÁº©ÂåÖ
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ÁîüÊàêËá™ÂÆö‰πâ Release Notes
        id: notes
        shell: bash
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s")
          else
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s")
          fi
          
          # ÂàùÂßãÂåñÂàÜÁ±ª
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          OTHERS=""
          
          # ÂàÜÁ±ªÂ§ÑÁêÜÊØè‰∏™ commit
          while IFS= read -r line; do
            if [[ $line =~ ^feat(\(.*\))?:\ (.*) ]]; then
              FEATURES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^fix(\(.*\))?:\ (.*) ]]; then
              FIXES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^(perf|refactor|improvement)(\(.*\))?:\ (.*) ]]; then
              IMPROVEMENTS+="* ${BASH_REMATCH[3]}"$'\n'
            elif [[ ! $line =~ ^(chore|docs|test|ci)(\(.*\))?:\ (.*) ]]; then
              OTHERS+="* $line"$'\n'
            fi
          done <<< "$COMMITS"
          
          # ÁîüÊàê Release Notes
          NOTES="## Êõ¥Êñ∞"$'\n'
          
          if [ -n "$FEATURES" ]; then
            NOTES+="### ‚ú® Êñ∞Â¢û"$'\n'
            NOTES+="$FEATURES"
          fi
          
          if [ -n "$FIXES" ]; then
            NOTES+="### üêõ ‰øÆÂ§ç"$'\n'
            NOTES+="$FIXES"
          fi
          
          if [ -n "$IMPROVEMENTS" ]; then
            NOTES+="### üîÑ ÊîπËøõ"$'\n'
            NOTES+="$IMPROVEMENTS"
          fi
          
          if [ -n "$OTHERS" ]; then
            NOTES+="### üìù ÂÖ∂‰ªñ"$'\n'
            NOTES+="$OTHERS"
          fi
          
          NOTES+="***"$'\n'
          NOTES+="ÂÆåÊï¥Êõ¥Êñ∞Êó•Âøó"
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ÂèëÂ∏ÉÂà∞ ReleaseÔºàÂπ∂ÂàõÂª∫ tagÔºâ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          files: artifacts/**/*
          body: ${{ steps.notes.outputs.release_notes }}

  docker:
    needs: [check-version, test]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Ê£ÄÂá∫‰ª£Á†Å
        uses: actions/checkout@v4

      - name: ËÆæÁΩÆ Buildx
        uses: docker/setup-buildx-action@v3

      - name: ÁôªÂΩï GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ÁîüÊàêÈïúÂÉèÊ†áÁ≠æ
        id: meta
        shell: bash
        env:
          REPOSITORY: ${{ github.repository }}
          VERSION: ${{ needs.check-version.outputs.version }}
        run: |
          repo_lc="${REPOSITORY,,}"
          image="ghcr.io/${repo_lc}"
          version_tag="v${VERSION,,}"
          if [[ "$version_tag" =~ ^v([0-9]+)\.([0-9]+)\.0$ ]]; then
            version_tag="v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
          fi
          tags="${image}:${version_tag},${image}:latest"
          echo "tags=${tags}" >> "$GITHUB_OUTPUT"
          echo "version=${version_tag}" >> "$GITHUB_OUTPUT"

      - name: ÊûÑÂª∫Âπ∂Êé®ÈÄÅ
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          target: runtime-sea
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            PHIRA_MP_VERSION=${{ steps.meta.outputs.version }}
          pull: true
          no-cache: true

      - name: Ê∏ÖÁêÜÊûÑÂª∫ÁºìÂ≠ò
        if: always()
        shell: bash
        run: |
          docker builder prune -af || true
          docker system prune -af || true
