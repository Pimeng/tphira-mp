# å½“ push åˆ° main ä¸”æœ¬æäº¤çš„ package.json version æ¯”ä¸Šä¸€æäº¤æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨ï¼šæµ‹è¯• â†’ æ„å»º â†’ å‘å¸ƒ
name: ç‰ˆæœ¬å·å˜æ›´æ—¶è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  packages: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦æ¯”ä¸Šä¸€æäº¤æ›´æ–°
        id: check
        run: |
          current=$(node -p "require('./package.json').version")
          echo "version=$current" >> "$GITHUB_OUTPUT"

          git show HEAD~1:package.json > /tmp/old-package.json 2>/dev/null || true
          if [[ -s /tmp/old-package.json ]]; then
            previous=$(node -p "try { require('/tmp/old-package.json').version } catch(e) { '0.0.0' }" 2>/dev/null) || previous="0.0.0"
          else
            previous="0.0.0"
          fi

          should_release=$(node -e "
            const parse = v => (v || '0.0.0').split('.').map(x => parseInt(x) || 0);
            const a = parse(process.argv[1]), b = parse(process.argv[2]);
            const len = Math.max(a.length, b.length);
            for (let i = 0; i < len; i++) {
              const av = a[i] || 0, bv = b[i] || 0;
              if (av > bv) { console.log('true'); process.exit(0); }
              if (av < bv) break;
            }
            console.log('false');
          " "$current" "$previous")

          echo "should_release=$should_release" >> "$GITHUB_OUTPUT"

          if [[ "$should_release" == "true" ]]; then
            echo "å½“å‰æäº¤ç‰ˆæœ¬: $current > ä¸Šä¸€æäº¤: $previousï¼Œè§¦å‘å‘å¸ƒ"
          else
            echo "å½“å‰ $current æœªé«˜äºä¸Šä¸€æäº¤ $previousï¼Œè·³è¿‡å‘å¸ƒ"
          fi

  test:
    needs: [check-version]
    if: needs.check-version.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10.29.3"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm test

  build:
    needs: [check-version, test]
    if: needs.check-version.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "10.29.3"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: pnpm run package:sea

      - name: åˆ¶ä½œå‹ç¼©åŒ…ï¼ˆWinï¼‰
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $os = "${{ runner.os }}".ToLowerInvariant()
          $arch = "${{ runner.arch }}".ToLowerInvariant()
          $name = "phira-mp-$os-$arch.zip"
          if (Test-Path $name) { Remove-Item $name -Force }
          Compress-Archive -Path release\* -DestinationPath $name

      - name: åˆ¶ä½œå‹ç¼©åŒ…ï¼ˆLinux/macOSï¼‰
        if: runner.os != 'Windows'
        shell: bash
        run: |
          os="$(printf "%s" "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')"
          arch="$(printf "%s" "${{ runner.arch }}" | tr '[:upper:]' '[:lower:]')"
          name="phira-mp-${os}-${arch}.zip"
          rm -f "$name"
          (cd release && zip -r "../$name" .)

      - name: ä¸Šä¼ å‹ç¼©åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: phira-mp-${{ runner.os }}-${{ runner.arch }}
          path: |
            phira-mp-*.zip

  release:
    if: startsWith(github.ref, 'refs/tags/') || needs.check-version.outputs.should_release == 'true'
    needs: [check-version, build]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½å‹ç¼©åŒ…
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ç”Ÿæˆè‡ªå®šä¹‰ Release Notes
        id: notes
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION="${{ needs.check-version.outputs.version }}"
          echo "å½“å‰ç‰ˆæœ¬: v${CURRENT_VERSION}"
          
          # ä» GitHub Releases è·å–æœ€æ–°çš„å·²å‘å¸ƒç‰ˆæœ¬å·
          PREVIOUS_VERSION=$(gh release list --limit 100 --json tagName,isPrerelease \
            --jq '[.[] | select(.isPrerelease == false) | .tagName] | .[0]' 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_VERSION" ]; then
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ä¸ª releaseï¼Œè¯»å–æ‰€æœ‰æäº¤"
            COMMITS=$(git log --pretty=format:"%s")
          else
            echo "æ‰¾åˆ°ä¸Šä¸€ä¸ª release ç‰ˆæœ¬: ${PREVIOUS_VERSION}"
            
            # è·å–è¿œç¨‹ tags
            git fetch --tags origin
            
            # éªŒè¯è¿œç¨‹ tag æ˜¯å¦å­˜åœ¨
            if git rev-parse "refs/tags/${PREVIOUS_VERSION}" >/dev/null 2>&1; then
              echo "ä»è¿œç¨‹ tag ${PREVIOUS_VERSION} åˆ° HEAD å¯¹æ¯”æäº¤"
              COMMITS=$(git log ${PREVIOUS_VERSION}..HEAD --pretty=format:"%s")
            else
              echo "è­¦å‘Š: è¿œç¨‹ tag ${PREVIOUS_VERSION} ä¸å­˜åœ¨ï¼Œè¯»å–æ‰€æœ‰æäº¤"
              COMMITS=$(git log --pretty=format:"%s")
            fi
          fi
          
          echo "æäº¤åˆ—è¡¨ï¼š$COMMITS"
          
          # åˆå§‹åŒ–åˆ†ç±»
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          OTHERS=""
          
          # åˆ†ç±»å¤„ç†æ¯ä¸ª commit
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œ
            [[ -z "$line" ]] && continue
            
            if [[ $line =~ ^feat(\(.*\))?:\ (.*) ]]; then
              FEATURES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^fix(\(.*\))?:\ (.*) ]]; then
              FIXES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^(perf|refactor|improvement|chore)(\(.*\))?:\ (.*) ]]; then
              IMPROVEMENTS+="* ${BASH_REMATCH[3]}"$'\n'
            elif [[ ! $line =~ ^(docs|test|ci)(\(.*\))?:\ (.*) ]]; then
              # ä¸å¿½ç•¥ä»»ä½•å…¶ä»–æ ¼å¼çš„æäº¤ï¼Œåªå¿½ç•¥ docs/test/ci
              if [[ ! -z "$line" ]]; then
                OTHERS+="* $line"$'\n'
              fi
            fi
          done <<< "$COMMITS"
          
          # ç”Ÿæˆ Release Notes
          NOTES="## æ›´æ–°"$'\n'
          
          if [ -n "$FEATURES" ]; then
            NOTES+="### âœ¨ æ–°å¢"$'\n'
            NOTES+="$FEATURES"
          fi
          
          if [ -n "$FIXES" ]; then
            NOTES+="### ğŸ› ä¿®å¤"$'\n'
            NOTES+="$FIXES"
          fi
          
          if [ -n "$IMPROVEMENTS" ]; then
            NOTES+="### ğŸ”„ æ”¹è¿›"$'\n'
            NOTES+="$IMPROVEMENTS"
          fi
          
          if [ -n "$OTHERS" ]; then
            NOTES+="### ğŸ“ å…¶ä»–"$'\n'
            NOTES+="$OTHERS"
          fi
          
          NOTES+="***"$'\n'
          NOTES+="å®Œæ•´æ›´æ–°æ—¥å¿—"
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: åˆ—å‡º artifacts ç›®å½•ç»“æ„
        shell: bash
        run: find artifacts -type f -name "*.zip" | head -20

      - name: å‘å¸ƒåˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.version }}
          files: |
            artifacts/phira-mp-Linux-ARM64/*.zip
            artifacts/phira-mp-Linux-X64/*.zip
            artifacts/phira-mp-Windows-X64/*.zip
            artifacts/phira-mp-macOS-ARM64/*.zip
          body: ${{ steps.notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    if: startsWith(github.ref, 'refs/tags/') || needs.check-version.outputs.should_release == 'true'
    needs: [check-version, release]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        shell: bash
        env:
          REPOSITORY: ${{ github.repository }}
          VERSION: ${{ needs.check-version.outputs.version }}
        run: |
          repo_lc="${REPOSITORY,,}"
          image="ghcr.io/${repo_lc}"
          version_tag="v${VERSION,,}"
          if [[ "$version_tag" =~ ^v([0-9]+)\.([0-9]+)\.0$ ]]; then
            version_tag="v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
          fi
          tags="${image}:${version_tag},${image}:latest"
          echo "tags=${tags}" >> "$GITHUB_OUTPUT"
          echo "version=${version_tag}" >> "$GITHUB_OUTPUT"

      - name: æ„å»ºå¹¶æ¨é€
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          target: runtime-sea
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            PHIRA_MP_VERSION=${{ steps.meta.outputs.version }}
          pull: true
          no-cache: true

      - name: æ¸…ç†æ„å»ºç¼“å­˜
        if: always()
        shell: bash
        run: |
          docker builder prune -af || true
          docker system prune -af || true
