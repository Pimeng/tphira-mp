name: æ‰‹åŠ¨æ„å»º Release å’Œ Docker

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œè‡ªåŠ¨æ„å»ºè¯·æ”¹ package.json ç‰ˆæœ¬å·å¹¶ push åˆ° main

permissions:
  contents: write
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm test

  build:
    needs: [test]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: è®¾ç½® pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9.15.4"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
        run: pnpm run package:sea

      - name: åˆ¶ä½œå‹ç¼©åŒ…ï¼ˆWinï¼‰
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $os = "${{ runner.os }}".ToLowerInvariant()
          $arch = "${{ runner.arch }}".ToLowerInvariant()
          $name = "phira-mp-$os-$arch.zip"
          if (Test-Path $name) { Remove-Item $name -Force }
          Compress-Archive -Path release\* -DestinationPath $name

      - name: åˆ¶ä½œå‹ç¼©åŒ…ï¼ˆLinux/macOSï¼‰
        if: runner.os != 'Windows'
        shell: bash
        run: |
          os="$(printf "%s" "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')"
          arch="$(printf "%s" "${{ runner.arch }}" | tr '[:upper:]' '[:lower:]')"
          name="phira-mp-${os}-${arch}.zip"
          rm -f "$name"
          (cd release && zip -r "../$name" .)

      - name: ä¸Šä¼ å‹ç¼©åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: phira-mp-${{ runner.os }}-${{ runner.arch }}
          path: |
            phira-mp-*.zip

  release-and-docker:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½å‹ç¼©åŒ…
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ç”Ÿæˆè‡ªå®šä¹‰ Release Notes
        id: notes
        shell: bash
        run: |
          # è·å–æœ€æ–°çš„ä¸Šä¸€ä¸ª tagï¼ˆç²¾ç¡®åŒ¹é… v å‰ç¼€ï¼‰
          PREVIOUS_TAG=$(git tag -l 'v*' --sort=-version:refname --merged HEAD | tail -n +2 | head -n 1 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # æ²¡æœ‰ä»»ä½• tagï¼Œè·å–æ‰€æœ‰æäº¤
            COMMITS=$(git log --pretty=format:"%s")
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ä¸ª tagï¼Œè¯»å–æ‰€æœ‰æäº¤"
          else
            # ä»ä¸Šä¸€ä¸ª tag åˆ°å½“å‰æäº¤çš„æ‰€æœ‰æäº¤
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"%s")
            echo "ä» ${PREVIOUS_TAG} åˆ° HEAD è¯»å–æäº¤"
          fi
          
          echo "æäº¤åˆ—è¡¨ï¼š$COMMITS"
          
          # åˆå§‹åŒ–åˆ†ç±»
          FEATURES=""
          FIXES=""
          IMPROVEMENTS=""
          OTHERS=""
          
          # åˆ†ç±»å¤„ç†æ¯ä¸ª commit
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œ
            [[ -z "$line" ]] && continue
            
            if [[ $line =~ ^feat(\(.*\))?:\ (.*) ]]; then
              FEATURES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^fix(\(.*\))?:\ (.*) ]]; then
              FIXES+="* ${BASH_REMATCH[2]}"$'\n'
            elif [[ $line =~ ^(perf|refactor|improvement|chore)(\(.*\))?:\ (.*) ]]; then
              IMPROVEMENTS+="* ${BASH_REMATCH[3]}"$'\n'
            elif [[ ! $line =~ ^(docs|test|ci)(\(.*\))?:\ (.*) ]]; then
              # ä¸å¿½ç•¥ä»»ä½•å…¶ä»–æ ¼å¼çš„æäº¤ï¼Œåªå¿½ç•¥ docs/test/ci
              if [[ ! -z "$line" ]]; then
                OTHERS+="* $line"$'\n'
              fi
            fi
          done <<< "$COMMITS"
          
          # ç”Ÿæˆ Release Notes
          NOTES="## æ›´æ–°"$'\n'
          
          if [ -n "$FEATURES" ]; then
            NOTES+="### âœ¨ æ–°å¢"$'\n'
            NOTES+="$FEATURES"
          fi
          
          if [ -n "$FIXES" ]; then
            NOTES+="### ğŸ› ä¿®å¤"$'\n'
            NOTES+="$FIXES"
          fi
          
          if [ -n "$IMPROVEMENTS" ]; then
            NOTES+="### ğŸ”„ æ”¹è¿›"$'\n'
            NOTES+="$IMPROVEMENTS"
          fi
          
          if [ -n "$OTHERS" ]; then
            NOTES+="### ğŸ“ å…¶ä»–"$'\n'
            NOTES+="$OTHERS"
          fi
          
          NOTES+="***"$'\n'
          NOTES+="å®Œæ•´æ›´æ–°æ—¥å¿—"
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: è·å–å½“å‰ç‰ˆæœ¬
        id: version
        shell: bash
        run: |
          version=$(node -p "require('./package.json').version")
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: å‘å¸ƒåˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          files: artifacts/**/*.zip
          body: ${{ steps.notes.outputs.release_notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
        id: meta
        shell: bash
        env:
          REPOSITORY: ${{ github.repository }}
        run: |
          repo_lc="${REPOSITORY,,}"
          image="ghcr.io/${repo_lc}"

          version="$(node -p "JSON.parse(require('fs').readFileSync('package.json','utf8')).version")"
          version_lc="${version,,}"
          version_tag="v${version_lc}"
          if [[ "$version_lc" =~ ^([0-9]+)\.([0-9]+)\.0$ ]]; then
            version_tag="v${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
          fi

          tags=()
          tags+=("${image}:${version_tag}")
          tags+=("${image}:latest")

          printf "tags=%s\n" "$(IFS=, ; echo "${tags[*]}")" >> "$GITHUB_OUTPUT"
          printf "version=%s\n" "$version_tag" >> "$GITHUB_OUTPUT"

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          target: runtime-sea
          tags: ${{ steps.meta.outputs.tags }}
          build-args: |
            PHIRA_MP_VERSION=${{ steps.meta.outputs.version }}
          pull: true
          no-cache: true

      - name: æ¸…ç†æ„å»ºç¼“å­˜
        if: always()
        shell: bash
        run: |
          docker builder prune -af || true
          docker system prune -af || true
